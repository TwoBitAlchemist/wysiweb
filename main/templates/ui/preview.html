{% extends 'elements/document.html' %}
{% load staticfiles %}
{% block preview_extra_headers %}
{% if DEBUG %}<style>.selected{border: 2px dotted red;}</style>{% endif %}
<script src="{% static 'admin/js/_djangoAjaxInit.js' %}"></script>
<script src="{% static 'admin/js/libs/esrever/src/esrever.js' %}"></script>
<script src="{% static 'admin/js/libs/rangy/lib/rangy-core.js' %}"></script>
<script src="{% static 'admin/js/libs/rangy/lib/rangy-classapplier.js' %}"></script>
<script src="{% static 'admin/js/libs/rangy/lib/rangy-textrange.js' %}"></script>
<script src="//tinymce.cachefly.net/4.1/tinymce.min.js"></script>
<script>
var rangy, timerID, wrapper;
$(document).ready(function(){
    rangy.init();
    var rangy_opts = {normalize: true, applyToEditableOnly: true};
    wrapper = rangy.createCssClassApplier('selected', rangy_opts);

    tinymce.init({
        setup: function(editor) {
            editor.on('change', function(e) {
                var component = tinymce.activeEditor.dom;
                if (!component.hasClass(this.id, 'updated')) {
                    component.addClass(this.id, 'updated');
                }
                tinyMCE.DOM.removeClass('.last_edited', 'last_edited');
                component.addClass(this.id, 'last_edited');
            })
        },
        selector: '*[data-object]',
        inline: true,
        menubar: false
    });

    $('span.highlight_element')
        .css({
            'color': 'dodgerblue',
            'cursor': 'pointer',
            'text-decoration': 'underline'
        })
        .click(function(){
            var flash = $(window.parent.document).find('#'+$(this).data('id'));
            var interval = window.setInterval(function(){
                flash.toggleClass('flash');
            }, 100);
            window.setTimeout(function(){
                window.clearInterval(interval);
            }, 1100);
        });
}).on('mouseup keydown', '*[data-object]', function(){
    if (timerID) window.clearTimeout(timerID);
    timerID = window.setTimeout(function(){
        var sel = rangy.getSelection();
        if (sel.toString().length > 1) {
            wrapper.applyToSelection();
            var selected = $('.selected');
            var selected_text = esrever.reverse(selected.text());
            var component = selected.closest('*[data-object]');
            var component_text = esrever.reverse(component.text().trim());
            if (selected_text != component_text) {
                if (component_text.indexOf(selected_text)) {
                    wrapper.undoToSelection();
                    sel.expand('word', {
                        trim: true
                    });
                } else {
                    var range = sel.getRangeAt(0);
                    range.move('word', -1);
                    range.setEndAfter(selected.parent()[0]);
                    wrapper.undoToSelection();
                    sel.setSingleRange(range);
                }
                wrapper.applyToSelection();
            }
        }
    }, 120);
}).on('mousedown', '*[data-object]', function(){
    $('.selected').each(function(){
        var s = $(this);
        s.replaceWith(s.html());
    });
});
</script>
{% endblock %}
{% block preview_hidden %}
{% load mptt_tags %}
{% load wysiweb_filters %}
{% recursetree elements.all %}
<input type="hidden" value="{{ node.text }}"
    id="{{ node|elemid }}-text">
{% if not node.is_leaf_node %}
{{ children }}
{% endif %}
{% endrecursetree %}
{% endblock %}
